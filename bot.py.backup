import urllib
from pyexpat.errors import messages
from time import sleep

import telebot
import re
import subprocess
import sqlite3


bot = telebot.TeleBot('8365572085:AAHpIPbYK29p6kw6TzUBzRIdlz96zGCvrDE')
namevpn = ''
@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id, '–ù—É —á—Ç–æ, —Å—Ç–∞—Ä—Ç—É–µ–º!\n\n–°–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥:\n'
                                      '/adduser –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ')

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∏ —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
conn = sqlite3.connect('users.db')
c = conn.cursor()
c.execute('CREATE TABLE IF NOT EXISTS users(id int auto_increment primary key, username)')
conn.commit()
c.close()
conn.close()
@bot.message_handler(commands=['adduser'])
def add_user(message):

    name =  bot.send_message(message.chat.id, '–í–≤–µ–¥–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è(–ª—é–±–æ–µ)')
    bot.register_next_step_handler(name, check_name)

def check_name(message):
    global namevpn
    namevpn = message.text.strip().lower()
    msg = message
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    check_in_bd = c.execute('SELECT * FROM users WHERE username = ?', (namevpn,))
    exists = check_in_bd.fetchone()
    if exists:
        msg = bot.send_message(message.chat.id, '—Ç–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–≤–µ–¥–∏ –¥—Ä—É–≥–æ–µ –∏–º—è')
        bot.register_next_step_handler(msg, check_name)
    else:
        if re.search(r'[^–∞-—è–ê-–Ø—ë–Å:;/?!@#$%^&*()]', namevpn) and namevpn.isalpha() == True:

            bot.send_message(message.chat.id, f'–û—Ç–ª–∏—á–Ω–æ, {namevpn} –Ω–µ –∑–∞–Ω—è—Ç–æ, —Å–µ–π—á–∞—Å —Å–æ–∑–¥–∞–¥–∏–º...')
            create_vpn_profile(message)

        else:
            name = bot.send_message(message.chat.id, f'–ò–º—è –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤ \n'
                                                     f'–í–≤–µ–¥–∏ –µ—â–µ —Ä–∞–∑')
            bot.register_next_step_handler(name, check_name)
    c.close()
    conn.close()
    print(check_in_bd)

@bot.message_handler(commands=['dbview'])
def dbview(message):
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    c.execute('SELECT * FROM users')
    users = c.fetchall()
    info = ''
    for el in users:
         info += f'{el[1]}\n'
    c.close()
    conn.close()
    bot.send_message(message.chat.id, info)

def create_vpn_profile(message):

    print(namevpn)
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    c.execute(f"INSERT INTO users (username) VALUES ('{namevpn}')")
    conn.commit()
    c.close()
    conn.close()
    command = f'ikev2.sh --addclient {namevpn}'
    print(command)
    subprocess.check_output(command, shell=True)


    iosB = telebot.types.InlineKeyboardButton(f'üì±iOS', callback_data='iOS_profile')
    aUnd11B = telebot.types.InlineKeyboardButton(f'ü§ñ Android –¥–æ v11', callback_data='sswan_profile')
    aAft11B = telebot.types.InlineKeyboardButton(f'ü§ñ Android V11 –∏ –±–æ–ª—å—à–µ', callback_data='android_profile')
    macB = telebot.types.InlineKeyboardButton(f'üíª MacOS', callback_data='MacOS_profile')
    winB = telebot.types.InlineKeyboardButton(f'ü™ü Windows', callback_data='win_profile')
    row1 = [iosB,macB]
    row2 = [aUnd11B,aAft11B]
    row3 = [winB]
    buttons = [row1, row2, row3]
    markup = telebot.types.InlineKeyboardMarkup(buttons)
    bot.send_message(message.chat.id,  f'–ì–æ—Ç–æ–≤–æ, –≤—ã–±–µ—Ä–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∫—É–¥–∞ –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–ü–ù', reply_markup=markup)


@bot.callback_query_handler(func=lambda call: True)
def callback(call):
    if call.data == 'iOS_profile':
        ios_p(call)
    if call.data == 'sswan_profile':
        sswan_profile(call)
    if call.data == 'android_profile':
        android_p(call)
    if call.data == 'win_profile':
        win_profile(call)
    if call.data == 'MacOS_profile':
        macos_profile(call)



def ios_p(call):
    bot.send_message(call.message.chat.id,f'Sending ios profile {namevpn}')
    bot.send_message(call.message.chat.id, "<a href='https://telegra.ph/Testovaya-instrukciya-dlya-IOS-01-17'>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è iOS</a>", parse_mode='HTML')
    bot.send_document(call.message.chat.id, open(f"/root/{namevpn}.mobileconfig", "rb"))

def android_p(call):
    bot.send_message(call.message.chat.id,f'Sending android profile {namevpn}')
    bot.send_message(call.message.chat.id, "<a href='https://telegra.ph/Instrukciya-Android-v11-01-17'>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è Android</a>", parse_mode='HTML')
    bot.send_document(call.message.chat.id, open(f"/root/{namevpn}.p12", "rb"))

def sswan_profile(call):
    bot.send_message(call.message.chat.id,f'Sending sswan profile {namevpn}')
    bot.send_message(call.message.chat.id, "<a href='https://telegra.ph/Instrukciya-Android-do-11v-01-17'>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è StrongSwan</a>", parse_mode='HTML')
    bot.send_document(call.message.chat.id, open(f"/root/{namevpn}.sswan", "rb"))

def macos_profile(call):
    bot.send_message(call.message.chat.id,f'Sending macos profile {namevpn}')
    bot.send_message(call.message.chat.id, "<a href='https://telegra.ph/Instrukciya-macOS-01-17'>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è MacOS</a>", parse_mode='HTML')
    bot.send_document(call.message.chat.id, open(f"/root/{namevpn}.mobileconfig", "rb"))

def win_profile(call):
    bot.send_message(call.message.chat.id,f'Sending Windows profile {namevpn}')
    bot.send_message(call.message.chat.id, "<a href='https://telegra.ph/Instrukciya-dlya-Windows-01-17'>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è Windows</a>", parse_mode='HTML')
    bot.send_document(call.message.chat.id, open(f"/root/{namevpn}.p12", "rb"))
    bot.send_document(call.message.chat.id, open(f"/root/Enable_Stronger_Ciphers_for_IKEv2_on_Windows.reg", "rb"))
    bot.send_document(call.message.chat.id, open(f"/root/ikev2_config_import.cmd", "rb"))


@bot.message_handler(commands=['dbclear'])
def dbclear(message):
    conn = sqlite3.connect('users.db')
    c = conn.cursor()
    c.execute('DELETE FROM users')
    conn.commit()
    c.close()
    conn.close()
    bot.send_message(message.chat.id, 'Users deleted in DB')



bot.polling(none_stop=True)
